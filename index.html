<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mayil Taxi & Travels</title>
  <script>
    // Store current trip type
    let currentTripType = 'drop';
    // Store autocomplete objects
    let originAutocomplete;
    let destinationAutocomplete;
    
    // Initialize the app when the page loads
    function onLoad() {
      showLocationForm();
      // Load Google Maps API script
      loadGoogleMapsScript();
    }
    
    // Load Google Maps API script
    function loadGoogleMapsScript() {
      google.script.run
        .withSuccessHandler(function(apiKey) {
          const script = document.createElement('script');
          script.src = `https://maps.googleapis.com/maps/api/js?key=${apiKey}&libraries=places&callback=initAutocomplete`;
          script.async = true;
          script.defer = true;
          document.head.appendChild(script);
        })
        .getApiKey();
    }
    
    // Initialize Google Maps autocomplete
    function initAutocomplete() {
      // Create autocomplete for origin input
      originAutocomplete = new google.maps.places.Autocomplete(
        document.getElementById('origin'),
        { types: ['geocode'] }
      );
      
      // Create autocomplete for destination input
      destinationAutocomplete = new google.maps.places.Autocomplete(
        document.getElementById('destination'),
        { types: ['geocode'] }
      );
      
      // Set up listeners to handle when places change
      originAutocomplete.addListener('place_changed', function() {
        const place = originAutocomplete.getPlace();
        if (!place.geometry) {
          // User didn't select a prediction
          return;
        }
      });
      
      destinationAutocomplete.addListener('place_changed', function() {
        const place = destinationAutocomplete.getPlace();
        if (!place.geometry) {
          // User didn't select a prediction
          return;
        }
      });
    }
    
    // Show the location form for Drop Trip
    function showLocationForm() {
      const container = document.getElementById('content');
      container.innerHTML = `
        <h2>Enter Trip Details</h2>
        <div>
          <label for="origin">From:</label>
          <input type="text" id="origin" placeholder="Enter pickup location">
        </div>
        <div>
          <label for="destination">To:</label>
          <input type="text" id="destination" placeholder="Enter drop location">
        </div>
        <button onclick="calculateDistance()">Calculate Distance</button>
      `;
    }
    
    // Calculate distance between locations using server-side function
    function calculateDistance() {
      const origin = document.getElementById('origin').value;
      const destination = document.getElementById('destination').value;
      
      if (!origin || !destination) {
        alert('Please enter both pickup and drop locations.');
        return;
      }
      
      // Show loading message
      document.getElementById('content').innerHTML += '<p>Calculating distance...</p>';
      
      // Call server-side function to get distance
      google.script.run
        .withSuccessHandler(showDistance)
        .withFailureHandler(handleError)
        .getDistance(origin, destination);
    }
    
    // Handle distance calculation errors
    function handleError(error) {
      alert('Error: ' + error);
      showLocationForm();
    }
    
    // Show the calculated distance
    function showDistance(result) {
      if (!result.success) {
        alert(result.error);
        showLocationForm();
        return;
      }
      
      const distance = result.distance;
      const duration = result.durationText;
      
      const container = document.getElementById('content');
      container.innerHTML = `
        <h2>Distance Result</h2>
        <p><strong>From:</strong> ${result.originAddress}</p>
        <p><strong>To:</strong> ${result.destinationAddress}</p>
        <p><strong>Distance:</strong> ${distance} km</p>
        <p><strong>Estimated Time:</strong> ${duration}</p>
        <button onclick="showLocationForm()">Search Again</button>
      `;
    }
  </script>
</head>
<body onload="onLoad()">
  <h1>Mayil Taxi & Travels</h1>
  <div id="content"></div>
</body>
</html>
